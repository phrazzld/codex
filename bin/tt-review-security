#!/bin/bash
# tt-review-security - Security vulnerability review using shared library

# Source the shared library
source "$(dirname "$0")/tt-common.sh"

tt_main() {
    # Configure this script
    tt_set_config \
        --template-name "review-security" \
        --output-file "CODE_REVIEW_SECURITY.md" \
        --description "Performs security vulnerability review for code changes"

    # Use the shared function for git diff setup
    tt_setup_diff_review "$@"

    # Set the template content
    tt_set_template << 'EOF'
# Security Vulnerability Review

Perform thorough security analysis of changed code to identify vulnerabilities and risks.

**FOCUS**: Review ONLY changed lines (+ in diff) for security vulnerabilities.

## Security Review Checklist

### 1. Input Validation & Injection
- **SQL Injection**: Parameterized queries, prepared statements
- **Command Injection**: Shell command execution, system calls
- **XSS**: Unescaped user input in HTML/JavaScript
- **Path Traversal**: File system access with user input
- **LDAP/XML/NoSQL Injection**: Other injection vectors

### 2. Authentication & Authorization
- **Weak Authentication**: Password policies, MFA
- **Session Management**: Secure cookies, session fixation
- **Access Control**: Privilege escalation, IDOR
- **JWT Issues**: Algorithm confusion, weak secrets

### 3. Data Protection
- **Sensitive Data Exposure**: Logging passwords, PII
- **Hardcoded Secrets**: API keys, passwords in code
- **Weak Cryptography**: Outdated algorithms, poor randomness
- **Insecure Storage**: Plaintext passwords, unencrypted data

### 4. Common Vulnerabilities
- **SSRF**: Server-side request forgery
- **XXE**: XML external entity injection
- **Deserialization**: Unsafe object deserialization
- **Race Conditions**: TOCTOU vulnerabilities
- **Resource Exhaustion**: DoS vulnerabilities

### 5. Dependencies & Configuration
- **Vulnerable Dependencies**: Known CVEs
- **Insecure Defaults**: Debug mode, verbose errors
- **CORS Misconfig**: Overly permissive policies
- **Security Headers**: Missing or misconfigured

## Output Format
```
# Security Review Report

## ðŸš¨ CRITICAL VULNERABILITIES
### [Vulnerability Title] - CRITICAL
- **Type**: [Injection/Auth/Crypto/etc]
- **Location**: file_path:line_numbers
- **Vulnerability**: [Specific security flaw]
- **Attack Vector**: [How it can be exploited]
- **Impact**: [Data breach/RCE/privilege escalation]
- **Fix**: [Specific remediation with code example]
- **CWE**: [CWE-XXX reference if applicable]

## âš ï¸ HIGH RISK ISSUES
### [Issue Title] - HIGH
- **Type**: [Category]
- **Location**: file_path:line_numbers
- **Risk**: [Security concern]
- **Exploit Scenario**: [How an attacker could use this]
- **Remediation**: [How to fix]

## ðŸ” MEDIUM RISK CONCERNS
### [Concern Title] - MEDIUM
- **Type**: [Category]
- **Location**: file_path:line_numbers
- **Issue**: [What's wrong]
- **Best Practice**: [What should be done]

## â„¹ï¸ LOW RISK / DEFENSE IN DEPTH
### [Issue Title] - LOW
- **Location**: file_path:line_numbers
- **Recommendation**: [Security hardening suggestion]

## ðŸ›¡ï¸ SECURITY CHECKLIST
- [ ] All user inputs validated and sanitized
- [ ] Authentication properly implemented
- [ ] Sensitive data encrypted at rest and in transit
- [ ] No hardcoded secrets or credentials
- [ ] Dependencies up to date with no known CVEs
- [ ] Security headers properly configured
- [ ] Error messages don't leak sensitive info

## ðŸ“Š SUMMARY
- Critical: X vulnerabilities (MUST fix before deploy)
- High: Y issues (Should fix before merge)
- Medium: Z concerns (Plan to address)
- Low: W recommendations (Consider for hardening)

Security Risk Level: [CRITICAL|HIGH|MEDIUM|LOW]
```

Prioritize real exploitable vulnerabilities over theoretical risks.
EOF
}

# Main execution
tt_main "$@"
tt_run