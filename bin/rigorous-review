#!/bin/bash

# Rigorous code review using autonomous AI agents
# Properly extracts clean text from their outputs

set -e

echo "🔍 Starting rigorous code review..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Create temp directory for intermediate files
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# Gemini: Architecture and Design Critic
echo "▶ Launching Gemini agent..."
gemini --prompt "
Conduct a ruthlessly honest code review of the changes in the current branch compared to main.

Figure out what changed. Understand why. Explore the entire codebase.

Evaluate:
- Is this the right approach or fundamentally flawed?
- Are there bugs, security issues, or performance problems?
- Is the code maintainable or a future nightmare?  
- Should this be completely rewritten differently?
- How's the test coverage and documentation?
- Will this scale? Is it operationally ready?

Classify findings:
BLOCKER | CRITICAL | STRONG | SUGGEST | NIT | RETHINK

If the entire approach is wrong, say so and explain the better way.
Be brutally honest. The goal is excellence, not feelings.
" </dev/null 2>/dev/null > "$TEMP_DIR/gemini_review.md" &
GEMINI_PID=$!

# Codex: The Ruthless Practitioner  
echo "▶ Launching Codex agent..."
codex -q "
Review all changes in the current branch.

You're a senior engineer who's seen everything. 
Find what's wrong. Find what could be better.
Consider if the entire approach should be rethought.

Check for:
- Correctness and bugs
- Design flaws and code smells
- Performance bottlenecks
- Security vulnerabilities
- Maintainability issues
- Missing tests or docs
- Better alternative approaches

Don't hold back. Excellence matters more than feelings.

Rate each finding: BLOCKER | CRITICAL | STRONG | SUGGEST | NIT | RETHINK
" 2>/dev/null | jq -r 'select(.type=="message" and .role=="assistant") | .content[0].text' > "$TEMP_DIR/codex_review.md" &
CODEX_PID=$!

# Show progress
echo "⏳ Agents are analyzing your codebase..."
wait $GEMINI_PID $CODEX_PID

echo "✓ Both agents complete"
echo ""

# Synthesis
echo "📊 Synthesizing reviews..."
codex -q "
Here are two code reviews to synthesize:

GEMINI REVIEW:
$(cat "$TEMP_DIR/gemini_review.md")

CODEX REVIEW:
$(cat "$TEMP_DIR/codex_review.md")

Create a unified verdict with this structure:

## Executive Summary
One paragraph: Should we merge, iterate, or start over?

## Blockers
Must fix before merge

## Critical Issues  
Should really fix

## Strong Recommendations
Would significantly improve

## Suggestions & Nits
Worth considering

## Verdict
READY TO MERGE | NEEDS WORK | RECONSIDER APPROACH | START OVER

Be concise and actionable.
" 2>/dev/null | jq -r 'select(.type=="message" and .role=="assistant") | .content[0].text' > "$TEMP_DIR/synthesis.md"

# Create final report
cat > RIGOROUS_REVIEW.md <<EOF
# 🔥 Rigorous Code Review - $(date +%Y-%m-%d)

Branch: $(git branch --show-current)

$(cat "$TEMP_DIR/synthesis.md")

---

## Detailed Reviews

### Gemini Analysis
$(cat "$TEMP_DIR/gemini_review.md")

### Codex Analysis
$(cat "$TEMP_DIR/codex_review.md")

---
Generated by autonomous AI agents with full repository context.
These agents were instructed to be brutally honest.
EOF

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ Review complete: RIGOROUS_REVIEW.md"
echo ""
echo "The agents have spoken. Read their verdict."