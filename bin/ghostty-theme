#!/bin/bash

# Ghostty theme switcher
# Functions: ghostty_light, ghostty_dark, ghostty_theme
# CLI: ghostty-theme light|dark|<theme>

set -euo pipefail

# Pick config path: env override → macOS default → XDG default
detect_config_path() {
    if [[ -n "${GHOSTTY_CONFIG:-}" ]]; then
        echo "$GHOSTTY_CONFIG"
        return
    fi

    local mac_path="$HOME/Library/Application Support/com.mitchellh.ghostty/config"
    local xdg_path="$HOME/.config/ghostty/config"

    if [[ -f "$mac_path" || -d "$(dirname "$mac_path")" ]]; then
        echo "$mac_path"
    else
        echo "$xdg_path"
    fi
}

CONFIG_PATH="$(detect_config_path)"
LOCAL_THEMES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../dotfiles/ghostty/themes" && pwd)"
DEFAULT_LIGHT_THEME="$LOCAL_THEMES_DIR/rose-pine-dawn"
DEFAULT_DARK_THEME="$LOCAL_THEMES_DIR/rose-pine"
USER_THEMES_DIR="$HOME/.config/ghostty/themes"
APP_THEMES_DIR="/Applications/Ghostty.app/Contents/Resources/ghostty/themes"

ensure_config() {
    mkdir -p "$(dirname "$CONFIG_PATH")"
    [[ -f "$CONFIG_PATH" ]] || touch "$CONFIG_PATH"
}

resolve_theme() {
    local name="$1"
    # If user passed an absolute/relative path, honor it
    if [[ "$name" == */* ]]; then
        echo "$name"
        return
    fi
    # Prefer local curated themes (dotfiles/ghostty/themes/<name>)
    if [[ -f "$LOCAL_THEMES_DIR/$name" ]]; then
        echo "$LOCAL_THEMES_DIR/$name"
        return
    fi
    # Fall back to bare name (Ghostty will look in its theme search paths)
    echo "$name"
}

write_theme() {
    local theme="$1"
    ensure_config

    local python_cmd=""
    if command -v python3 >/dev/null 2>&1; then
        python_cmd="python3"
    elif command -v python >/dev/null 2>&1; then
        python_cmd="python"
    fi

    if [[ -n "$python_cmd" ]]; then
        if grep -q '^[[:space:]]*theme[[:space:]]*=' "$CONFIG_PATH"; then
            "$python_cmd" - "$CONFIG_PATH" "$theme" <<'PY'
import pathlib, re, sys

path = pathlib.Path(sys.argv[1])
theme = sys.argv[2]

text = path.read_text()
line = f'theme = "{theme}"'
pattern = re.compile(r'(?m)^\s*theme\s*=.*$')

if pattern.search(text):
    text = pattern.sub(line, text, count=1)
else:
    text = (text.rstrip("\n") + "\n" if text else "") + line + "\n"

path.write_text(text)
PY
        else
            echo "theme = \"$theme\"" >> "$CONFIG_PATH"
        fi
    else
        # Fallback: BSD sed in-place replace or append
        if grep -q '^[[:space:]]*theme[[:space:]]*=' "$CONFIG_PATH"; then
            sed -i '' "s|^[[:space:]]*theme[[:space:]]*=.*$|theme = \"$theme\"|" "$CONFIG_PATH"
        else
            echo "theme = \"$theme\"" >> "$CONFIG_PATH"
        fi
    fi

    echo "Ghostty theme → $theme"
    echo "Note: Ghostty applies themes on new windows/tabs; open a new one to see the change."
}

ghostty_theme() {
    if [[ -z "${1:-}" ]]; then
        echo "Usage: ghostty_theme <theme>"
        return 1
    fi
    write_theme "$(resolve_theme "$1")"
}

ghostty_light() {
    local theme="${1:-$DEFAULT_LIGHT_THEME}"
    write_theme "$(resolve_theme "$theme")"
}

ghostty_dark() {
    local theme="${1:-$DEFAULT_DARK_THEME}"
    write_theme "$(resolve_theme "$theme")"
}

list_dir() {
    local label="$1"
    local dir="$2"
    if [[ -d "$dir" ]]; then
        echo "$label:"
        for f in "$dir"/*; do
            [[ -f "$f" ]] || continue
            echo "  $(basename "$f")"
        done
        echo
    fi
}

ghostty_list() {
    list_dir "Repo themes" "$LOCAL_THEMES_DIR"
    list_dir "User themes (~/.config/ghostty/themes)" "$USER_THEMES_DIR"
    list_dir "Built-in app themes" "$APP_THEMES_DIR"
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    case "${1:-}" in
        light) ghostty_light "${2:-}" ;;
        dark) ghostty_dark "${2:-}" ;;
        list) ghostty_list ;;
        "") echo "Usage: $(basename "$0") {light|dark|list|<theme>}"; exit 1 ;;
        *) ghostty_theme "$1" ;;
    esac
fi
