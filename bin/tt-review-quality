#!/bin/bash
# tt-review-quality - General code quality review using shared library

# Source the shared library
source "$(dirname "$0")/tt-common.sh"

tt_main() {
    # Configure this script
    tt_set_config \
        --template-name "review-quality" \
        --output-file "CODE_REVIEW_QUALITY.md" \
        --description "Performs comprehensive code quality review"

    # Use the shared function for git diff setup
    tt_setup_diff_review "$@"

    # Set the template content
    tt_set_template << 'EOF'
# Comprehensive Code Quality Review

Evaluate changed code for maintainability, readability, testability, and adherence to best practices.

**FOCUS**: Review changed lines (+ in diff) for overall code quality, excluding security and critical bugs (covered by other reviews).

## Quality Dimensions

### 1. Maintainability
- **Readability**: Clear intent, self-documenting code
- **Naming**: Meaningful, consistent, intention-revealing names
- **Structure**: Logical organization, proper separation
- **Documentation**: Useful comments (why, not what)
- **DRY Principle**: Appropriate code reuse

### 2. Testability
- **Test Coverage**: Are changes properly tested?
- **Test Quality**: Clear test names, focused assertions
- **Mockability**: Can components be tested in isolation?
- **Edge Cases**: Are boundary conditions covered?

### 3. Design & Architecture
- **SOLID Principles**: Single responsibility, open/closed, etc.
- **Coupling/Cohesion**: Loose coupling, high cohesion
- **Patterns**: Appropriate use of design patterns
- **Dependencies**: Clean dependency management

### 4. Error Handling & Robustness
- **Error Handling**: Consistent, appropriate error handling
- **Defensive Programming**: Input validation, null checks
- **Resource Management**: Proper cleanup, no leaks
- **Logging**: Appropriate logging levels and context

### 5. Performance & Efficiency
- **Algorithm Choice**: Appropriate data structures/algorithms
- **Resource Usage**: Memory, CPU, I/O efficiency
- **Caching**: Appropriate use of caching
- **Lazy Loading**: Deferred computation where beneficial

### 6. Code Standards
- **Language Idioms**: Following language-specific best practices
- **Framework Conventions**: Using framework features properly
- **Consistency**: Consistent style throughout changes
- **Modern Features**: Using appropriate language features

## Output Format
```
# Code Quality Review

## ðŸ”´ MAJOR QUALITY ISSUES
### [Issue Title] - HIGH
- **Quality Aspect**: [Maintainability/Testability/Design]
- **Location**: file_path:line_numbers
- **Problem**: [What makes this low quality]
- **Impact**: [How this affects the codebase]
- **Improvement**: [Specific better approach]
- **Example**:
  ```language
  // Current approach
  ```
  ```language
  // Improved approach
  ```

## ðŸŸ¡ MODERATE CONCERNS
### [Concern Title] - MEDIUM
- **Quality Aspect**: [Category]
- **Location**: file_path:line_numbers
- **Issue**: [Quality concern]
- **Suggestion**: [How to improve]
- **Benefit**: [Why this matters]

## ðŸŸ¢ MINOR IMPROVEMENTS
### [Improvement Title] - LOW
- **Location**: file_path:line_numbers
- **Current**: [What could be better]
- **Better**: [Suggested improvement]
- **Type**: [Style/Convention/Idiom]

## ðŸ“‹ MISSING ELEMENTS
### Tests
- [ ] Unit tests for [functionality]
- [ ] Integration tests for [interaction]
- [ ] Edge case coverage for [scenario]

### Documentation
- [ ] API documentation for [public methods]
- [ ] README updates for [new features]
- [ ] Code comments for [complex logic]

## âœ¨ POSITIVE OBSERVATIONS
### [Good Practice Title]
- **Location**: file_path:line_numbers
- **Strength**: [What was done well]
- **Why Good**: [Why this is exemplary]

## ðŸ“Š QUALITY METRICS
- **Maintainability Score**: [HIGH|MEDIUM|LOW]
- **Test Coverage**: [Adequate|Needs Work|Missing]
- **Code Clarity**: [Excellent|Good|Fair|Poor]
- **Design Quality**: [Well-structured|Acceptable|Needs Refactoring]

## ðŸŽ¯ IMPROVEMENT PRIORITIES
1. **Must Fix**: [Critical quality issues affecting maintainability]
2. **Should Improve**: [Important enhancements for long-term health]
3. **Consider**: [Nice-to-have improvements]

## âœ… SUMMARY
- Major Issues: X (blocking merge)
- Moderate Concerns: Y (should address)
- Minor Improvements: Z (optional)
- Missing Tests: A
- Missing Docs: B

Overall Quality Assessment: [EXCELLENT|GOOD|ACCEPTABLE|NEEDS WORK]
```

Focus on actionable improvements that enhance long-term maintainability and developer experience.
EOF
}

# Main execution
tt_main "$@"
tt_run